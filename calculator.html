<!DOCTYPE html>
<html lang="th" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nutrition Calculator | คำนวณโภชนาการจากสูตรอาหาร</title>
  <meta name="description" content="คำนวณคุณค่าทางโภชนาการจากวัตถุดิบ รองรับ yield/retention + พรีเซ็ตวิธีปรุง พร้อมส่งออก CSV/XLSX" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{ --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08); }
    :root,[data-theme="light"]{ --bg:#f6f8fc; --text:#0f172a; --muted:#5b677a; --card:#ffffff; --border:#e8edf3; --accent:#2563eb; --accent-weak:#e9f0ff; --chip:#f3f6fb; --chip-border:#e5ebf4; --link:#0b5ad9; --glass: rgba(255,255,255,.65);}
    [data-theme="dark"]{ --bg:#0b1220; --text:#e7ecf5; --muted:#8ea0bd; --card:#111827; --border:#1f2a44; --accent:#74c0fc; --accent-weak:#0c2d4f; --chip:#0f1729; --chip-border:#223154; --link:#a6c8ff; --glass: rgba(17,24,39,.55);}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(1200px 600px at 20% -10%, #dbeafe 0%, transparent 60%),radial-gradient(1200px 600px at 120% -10%, #ffe4e6 0%, transparent 60%),var(--bg);color:var(--text)}

    .topbar{position:sticky;top:0;z-index:10;background:var(--glass);backdrop-filter: blur(10px);border-bottom:1px solid var(--border)}
    .container{max-width:1100px;margin:0 auto;padding:0 20px}
    .topbar .wrap{display:flex;align-items:center;gap:14px;min-height:66px}
    .logo{display:inline-flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    .logo .dot{width:12px;height:12px;border-radius:999px;background:var(--accent)}
    .title{font-weight:800;font-size:18px;letter-spacing:.2px}
    .credit-top{margin-left:auto;font-size:13px;color:var(--muted)}
    .theme-btn{margin-left:8px;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer}

    .brandstrip{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin:14px 0}
    .brandstrip img{height:40px;object-fit:contain}
    [data-theme="dark"] .brandstrip img{filter:brightness(1) contrast(1.05)}

    header.hero{padding:28px 0 10px}
    header.hero h1{font-size:clamp(26px,3.2vw,40px);margin:6px 0 10px}
    header.hero .sub{margin:0;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--card);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;text-decoration:none}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:var(--accent);color:#fff;border:0}

    .card{background:var(--card);border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow)}
    .section{padding:14px 16px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    input, select{ width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text) }
    label{font-size:13px;color:var(--muted)}

    .table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;background:var(--card);vertical-align:middle}
    .table th{font-size:12px;color:var(--muted)}

    .chip{background:var(--chip);border:1px solid var(--chip-border);border-radius:12px;padding:10px 12px;font-size:13px;display:flex;justify-content:space-between;gap:8px}
    .nutri-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .muted{color:var(--muted)}
    footer{border-top:1px solid var(--border);padding:18px 0 40px;color:var(--muted);font-size:13px;margin-top:26px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div class="wrap">
        <a class="logo" href="index.html" aria-label="Home">
          <span class="dot"></span>
          <span class="title">Nutrition Calculator</span>
        </a>
        <div class="credit-top" id="creditTop"></div>
        <button class="theme-btn" id="themeToggle" title="สลับธีม">สลับธีม</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="brandstrip">
      <img id="logo1" alt="สถาบัน 1">
      <img id="logo2" alt="สถาบัน 2">
      <img id="logo3" alt="สถาบัน 3">
    </div>

    <header class="hero">
      <h1>คำนวณโภชนาการจากสูตรอาหาร</h1>
      <p class="sub">ใส่รายการวัตถุดิบและน้ำหนักดิบ (g) ระบบจะคำนวณสารอาหารรวม และแปลงเป็นค่า <strong>ต่อ 100 g</strong> และ <strong>ต่อ serving</strong><br>รองรับ <em>yield</em> และ <em>retention</em> ต่อสารอาหาร + พรีเซ็ตวิธีปรุง</p>
      <div class="row">
        <a class="btn" href="index.html">← กลับหน้า ค้นหาข้อมูลสำเร็จรูป</a>
        <a class="btn" href="data/ingredients.json" target="_blank" rel="noopener">ดูฐานข้อมูล (JSON)</a>
        <button class="btn" id="btnExportResults">Export ผลลัพธ์ (CSV)</button>
        <button class="btn" id="btnExportResultsXLSX">Export ผลลัพธ์ (XLSX)</button>
        <button class="btn" id="btnExportIngs">Export ตารางวัตถุดิบ (CSV)</button>
        <button class="btn" id="btnExportIngsXLSX">Export ตารางวัตถุดิบ (XLSX)</button>
      </div>
    </header>

    <!-- การตั้งค่าโดยรวม -->
    <div class="card section" style="margin-bottom:14px">
      <div class="grid cols-3">
        <div>
          <label>ขนาดหนึ่งหน่วยบริโภค (serving size, g)</label>
          <input id="servingSize" type="number" step="0.1" placeholder="เช่น 150">
        </div>
        <div>
          <label>จำนวนหน่วยต่อบรรจุภัณฑ์</label>
          <input id="servingsPerPack" type="number" step="0.1" placeholder="เช่น 3">
        </div>
        <div>
          <label>ตำแหน่งทศนิยม (การปัด)</label>
          <select id="roundDp">
            <option value="0">0</option>
            <option value="1" selected>1</option>
            <option value="2">2</option>
          </select>
        </div>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div>
          <label>ค้นหาวัตถุดิบจากฐานข้อมูล</label>
          <input id="searchIngredient" type="text" placeholder="พิมพ์เพื่อค้น เช่น ข้าวสวยหุงสุก, chicken, น้ำปลา" list="ing-list">
        </div>
        <div class="row">
          <button class="btn" id="btnAdd">+ เพิ่มแถว</button>
          <button class="btn" id="btnClear">ล้างตาราง</button>
          <button class="btn" id="btnSample">ใส่ตัวอย่าง</button>
        </div>
      </div>
      <p class="muted" style="margin-top:8px">หมายเหตุ: พรีเซ็ตวิธีปรุงเป็นค่าประมาณเพื่อสาธิต/สอน — ปรับตามบริบทจริงได้</p>
    </div>

    <datalist id="ing-list"></datalist>

    <!-- ตารางวัตถุดิบ -->
    <div class="card section" style="margin-bottom:14px; overflow:auto">
      <table class="table" id="ingTable">
        <thead>
          <tr>
            <th style="min-width:200px">ชื่อวัตถุดิบ</th>
            <th style="min-width:150px">วิธีปรุง (พรีเซ็ต)</th>
            <th style="min-width:120px">น้ำหนักดิบ (g)</th>
            <th style="min-width:110px">Yield</th>
            <th style="min-width:130px">Ret. โปรตีน</th>
            <th style="min-width:120px">Ret. ไขมัน</th>
            <th style="min-width:130px">Ret. คาร์บ</th>
            <th style="min-width:140px">Ret. ใยอาหาร</th>
            <th style="min-width:130px">Ret. โซเดียม</th>
            <th style="min-width:60px"></th>
          </tr>
        </thead>
        <tbody id="ingBody"></tbody>
      </table>
    </div>

    <!-- ผลลัพธ์ -->
    <div class="card section">
      <div class="grid cols-2">
        <div>
          <h3 style="margin:6px 0">ผลรวมทั้งจาน (หลังปรับ yield & retention)</h3>
          <div class="nutri-grid" id="totalsGrid"></div>
        </div>
        <div>
          <h3 style="margin:6px 0">แปลงผลลัพธ์</h3>
          <div class="nutri-grid" id="convertGrid"></div>
        </div>
      </div>
    </div>

    <!-- ตรวจทานมวลรวม -->
    <div class="card section" style="margin-top:14px">
      <h3 style="margin:6px 0">ตรวจทานมวลรวม (ใกล้ 100 g ต่อ 100 g)</h3>
      <div class="muted" id="massCheck"></div>
    </div>
  </div>

  <footer>
    <div class="container">
      <div>อ้างอิงการคำนวณ: Atwater factors (พลังงาน), แนวคิด yield/retention สำหรับการปรุงอาหาร</div>
      <div id="creditBottom"></div>
    </div>
  </footer>

<script>
// ===== เครดิต/โลโก้/ธีม =====
const CREDIT_TEXT = "ผู้จัดทำ: ครูศักดิ์สิทธิ์ บำรุง | แผนกวิชาอาหารและโภชนาการ วิทยาลัยอาชีวศึกษาสุโขทัย | © 2025";
const LOGOS = ["assets/img/logo1.png","assets/img/logo2.png","assets/img/logo3.png"];
const root = document.documentElement;
function applyTheme(t){ root.setAttribute('data-theme', t); localStorage.setItem('nf-theme', t); }
function toggleTheme(){ const cur = root.getAttribute('data-theme')||'light'; applyTheme(cur==='light'?'dark':'light'); }
(function initTheme(){ applyTheme(localStorage.getItem('nf-theme')||'light'); })();
document.getElementById('themeToggle').addEventListener('click', toggleTheme);
function safeSetLogo(id, src){ const el = document.getElementById(id); if(!el) return; el.onerror = ()=>{ el.style.display='none'; }; if(src) el.src = src; }

// ===== พรีเซ็ตวิธีปรุง (ค่าประมาณเพื่อสาธิต) =====
const PRESETS = {
  'ไม่มี/ดิบ':    { yld:1.00, rp:1.00, rf:1.00, rc:1.00, rfi:1.00, rna:1.00 },
  'ต้ม/ลวก/ตุ๋น': { yld:0.95, rp:0.95, rf:0.98, rc:0.95, rfi:0.90, rna:1.00 },
  'นึ่ง':         { yld:0.98, rp:0.97, rf:0.99, rc:0.97, rfi:0.92, rna:1.00 },
  'ผัด':          { yld:0.90, rp:0.95, rf:1.05, rc:0.95, rfi:0.90, rna:1.00 },
  'ทอด':          { yld:0.80, rp:0.93, rf:1.10, rc:0.90, rfi:0.85, rna:1.00 },
  'ย่าง/อบ':      { yld:0.80, rp:0.95, rf:1.00, rc:0.95, rfi:0.90, rna:1.00 }
};

// ===== โหลดฐานข้อมูลวัตถุดิบ (JSON/CSV) =====
let DB = []; // ต่อ 100 g
async function loadDB(){
  try{ const r = await fetch('data/ingredients.json', {cache:'no-store'}); if(r.ok){ DB = await r.json(); return; } }catch(e){ console.warn('โหลด JSON ไม่สำเร็จ:', e); }
  try{ const r2 = await fetch('data/ingredients.csv', {cache:'no-store'}); if(r2.ok){ const text = await r2.text(); DB = parseCSV(text); return; } }catch(e){ console.warn('โหลด CSV ไม่สำเร็จ:', e); }
  DB = [ { name:'ข้าวสวยหุงสุก', state:'cooked', protein:2.6, fat:0.3, carbs:28.0, fiber:0.4, sodium_mg:2 },
         { name:'อกไก่ดิบ', state:'raw', protein:21.0, fat:2.5, carbs:0.0, fiber:0.0, sodium_mg:70 } ];
  console.warn('ใช้ฐานข้อมูล fallback ในตัวสคริปต์');
}
function parseCSV(csvText){
  const lines = csvText.trim().split(/\r?\n/);
  const head = lines.shift().split(',');
  const idx = (k)=> head.indexOf(k);
  const out = [];
  for(const line of lines){
    if(!line.trim()) continue;
    const cols = line.split(',');
    out.push({
      name: (cols[idx('name')]||'').trim(),
      state: (cols[idx('state')]||'').trim(),
      protein: Number(cols[idx('protein')]||0),
      fat: Number(cols[idx('fat')]||0),
      carbs: Number(cols[idx('carbs')]||0),
      fiber: Number(cols[idx('fiber')]||0),
      sodium_mg: Number(cols[idx('sodium_mg')]||0)
    });
  }
  return out;
}

// ===== DOM =====
const $ = s=>document.querySelector(s);
const ingBody = $('#ingBody');
const searchBox = $('#searchIngredient');
const roundDp = $('#roundDp');
const servingSize = $('#servingSize');
const servingsPerPack = $('#servingsPerPack');
const totalsGrid = $('#totalsGrid');
const convertGrid = $('#convertGrid');
const massCheck = $('#massCheck');

window.addEventListener('DOMContentLoaded', async ()=>{
  const top = document.getElementById('creditTop'); const bottom = document.getElementById('creditBottom');
  if(top) top.textContent = CREDIT_TEXT; if(bottom) bottom.textContent = CREDIT_TEXT;
  const [l1,l2,l3] = LOGOS; safeSetLogo('logo1', l1); safeSetLogo('logo2', l2); safeSetLogo('logo3', l3);

  await loadDB();
  document.getElementById('ing-list').innerHTML = DB.map(d=>`<option value="${d.name}">`).join('');

  addRow();
  compute();
});

// ===== Utilities =====
function r(v, dp){ const n = Number(v); if(!isFinite(n)) return 0; const f = Math.pow(10,dp); return Math.round(n*f)/f; }
function kcal(p, c, f, sugarAlcohol=0){ return (4*p) + (4*c) + (9*f) + (2.4*sugarAlcohol); }
function saltFromSodium_g(sodium_g){ return sodium_g * 2.5; }

// ===== เพิ่ม/ลบแถว + พรีเซ็ต =====
function addRow(prefill){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="ing-name" list="ing-list" placeholder="ชื่อวัตถุดิบ" value="${prefill?.name||''}"></td>
    <td>
      <select class="ing-method">
        ${Object.keys(PRESETS).map(k=>`<option ${prefill?.method===k?'selected':''}>${k}</option>`).join('')}
      </select>
    </td>
    <td><input class="ing-raw" type="number" step="0.1" placeholder="g" value="${prefill?.raw||''}"></td>
    <td><input class="ing-yield" type="number" step="0.01" placeholder="เช่น 0.85" value="${prefill?.yld??1}"></td>
    <td><input class="ing-ret-p" type="number" step="0.01" placeholder="เช่น 0.95" value="${prefill?.rp??1}"></td>
    <td><input class="ing-ret-f" type="number" step="0.01" placeholder="เช่น 1.00" value="${prefill?.rf??1}"></td>
    <td><input class="ing-ret-c" type="number" step="0.01" placeholder="เช่น 0.90" value="${prefill?.rc??1}"></td>
    <td><input class="ing-ret-fi" type="number" step="0.01" placeholder="เช่น 0.90" value="${prefill?.rfi??1}"></td>
    <td><input class="ing-ret-na" type="number" step="0.01" placeholder="เช่น 1.00" value="${prefill?.rna??1}"></td>
    <td><button class="btn btn-del">ลบ</button></td>
  `;
  ingBody.appendChild(tr);

  tr.querySelector('.btn-del').addEventListener('click', ()=>{ tr.remove(); compute(); });
  ['ing-name','ing-raw','ing-yield','ing-ret-p','ing-ret-f','ing-ret-c','ing-ret-fi','ing-ret-na'].forEach(cls=>{
    tr.querySelector('.'+cls).addEventListener('input', compute);
  });
  tr.querySelector('.ing-method').addEventListener('change', ()=>{
    const preset = PRESETS[tr.querySelector('.ing-method').value];
    if(!preset) return;
    tr.querySelector('.ing-yield').value  = preset.yld;
    tr.querySelector('.ing-ret-p').value  = preset.rp;
    tr.querySelector('.ing-ret-f').value  = preset.rf;
    tr.querySelector('.ing-ret-c').value  = preset.rc;
    tr.querySelector('.ing-ret-fi').value = preset.rfi;
    tr.querySelector('.ing-ret-na').value = preset.rna;
    compute();
  });
}

$('#btnAdd').addEventListener('click', ()=> addRow());
$('#btnClear').addEventListener('click', ()=>{ ingBody.innerHTML=''; compute(); });
$('#btnSample').addEventListener('click', ()=>{
  ingBody.innerHTML='';
  addRow({name:'ข้าวสวยหุงสุก', method:'ไม่มี/ดิบ', raw:300, yld:1.00, rp:1.00, rf:1.00, rc:1.00, rfi:1.00, rna:1.00});
  addRow({name:'อกไก่ดิบ', method:'ย่าง/อบ',   raw:200, yld:0.80, rp:0.95, rf:1.00, rc:0.95, rfi:0.90, rna:1.00});
  addRow({name:'น้ำปลา',   method:'ไม่มี/ดิบ', raw:15,  yld:1.00, rp:1.00, rf:1.00, rc:1.00, rfi:1.00, rna:1.00});
  servingSize.value = 150; servingsPerPack.value = 4; roundDp.value = 1;
  compute();
});

searchBox.addEventListener('change', ()=>{
  const val = searchBox.value.trim(); if(!val) return;
  const hit = DB.find(d=>d.name === val);
  if(hit){ addRow({name:hit.name, method:'ไม่มี/ดิบ', raw:100}); } else { addRow({name:val, method:'ไม่มี/ดิบ', raw:100}); }
  searchBox.value=''; compute();
});
[roundDp, servingSize, servingsPerPack].forEach(el=> el.addEventListener('input', compute));

// ===== แกนคำนวณ =====
function compute(){
  const dp = Number(roundDp.value||1);
  let totalProtein=0, totalFat=0, totalCarb=0, totalFiber=0, totalSodium_mg=0;
  let totalCookedWeight = 0;

  [...ingBody.querySelectorAll('tr')].forEach(tr=>{
    const name = tr.querySelector('.ing-name').value.trim();
    const raw = Number(tr.querySelector('.ing-raw').value||0);
    const yld = Number(tr.querySelector('.ing-yield').value||1);
    const rp  = Number(tr.querySelector('.ing-ret-p').value||1);
    const rf  = Number(tr.querySelector('.ing-ret-f').value||1);
    const rc  = Number(tr.querySelector('.ing-ret-c').value||1);
    const rfi = Number(tr.querySelector('.ing-ret-fi').value||1);
    const rna = Number(tr.querySelector('.ing-ret-na').value||1);
    if(!raw || raw<=0) return;

    const base = DB.find(d=>d.name===name);
    const P100 = base?.protein??0, F100 = base?.fat??0, C100 = base?.carbs??0, FI100 = base?.fiber??0, NA100_mg = base?.sodium_mg??0;

    const p = (P100/100) * raw;
    const f = (F100/100) * raw;
    const c = (C100/100) * raw;
    const fi= (FI100/100) * raw;
    const na_mg = (NA100_mg/100) * raw;

    const cookedWeight = raw * yld; totalCookedWeight += cookedWeight;

    totalProtein   += p * rp;
    totalFat       += f * rf;
    totalCarb      += c * rc;
    totalFiber     += fi * rfi;
    totalSodium_mg += na_mg * rna;
  });

  const FW = totalCookedWeight; // ใช้น้ำหนักสุทธิหลังปรุงจากผลรวม cooked weight
  const SS = Number(servingSize.value) || 0;

  const totalEnergy = kcal(totalProtein, totalCarb, totalFat);
  const totalSalt_g = saltFromSodium_g(totalSodium_mg/1000);

  const factor100 = FW>0 ? (100/FW) : 0;
  const p100 = totalProtein*factor100, f100 = totalFat*factor100, c100 = totalCarb*factor100, fi100 = totalFiber*factor100;
  const na100_mg = totalSodium_mg*factor100; const salt100_g = totalSalt_g*factor100; const kcal100 = kcal(p100, c100, f100);

  const factorS = (SS>0 && FW>0) ? (SS/FW) : 0;
  const ps = totalProtein*factorS, fs=totalFat*factorS, cs=totalCarb*factorS, fis=totalFiber*factorS;
  const nas_mg = totalSodium_mg*factorS; const salts_g = totalSalt_g*factorS; const kcals = kcal(ps, cs, fs);

  totalsGrid.innerHTML = [
    chip('พลังงานรวม', r(totalEnergy, dp), 'kcal'),
    chip('โปรตีนรวม', r(totalProtein, dp), 'g'),
    chip('ไขมันรวม', r(totalFat, dp), 'g'),
    chip('คาร์บรวม', r(totalCarb, dp), 'g'),
    chip('ใยอาหารรวม', r(totalFiber, dp), 'g'),
    chip('โซเดียมรวม', r(totalSodium_mg, dp), 'mg'),
    chip('เกลือรวม', r(totalSalt_g, dp), 'g'),
    chip('น้ำหนักสุทธิหลังปรุง', r(FW, dp), 'g')
  ].join('');

  convertGrid.innerHTML = [
    `<div class="chip"><strong>ต่อ 100 g</strong><span></span></div>`,
    chip('พลังงาน', r(kcal100, dp), 'kcal'),
    chip('โปรตีน', r(p100, dp), 'g'),
    chip('ไขมัน', r(f100, dp), 'g'),
    chip('คาร์บ', r(c100, dp), 'g'),
    chip('ใยอาหาร', r(fi100, dp), 'g'),
    chip('โซเดียม', r(na100_mg, dp), 'mg'),
    chip('เกลือ', r(salt100_g, dp), 'g'),
    `<div class="chip"><strong>ต่อ serving (${r(SS,dp)} g)</strong><span></span></div>`,
    chip('พลังงาน', r(kcals, dp), 'kcal'),
    chip('โปรตีน', r(ps, dp), 'g'),
    chip('ไขมัน', r(fs, dp), 'g'),
    chip('คาร์บ', r(cs, dp), 'g'),
    chip('ใยอาหาร', r(fis, dp), 'g'),
    chip('โซเดียม', r(nas_mg, dp), 'mg'),
    chip('เกลือ', r(salts_g, dp), 'g')
  ].join('');

  const ash = 2; // สมมุติเพื่อการสอน
  const moisture = 100 - (p100 + f100 + c100 + fi100 + ash);
  massCheck.textContent = `โปรตีน + ไขมัน + คาร์บ + ใยอาหาร + เถ้า(${ash} g) + ความชื้น(คำนวณ) = ${r(p100,1)} + ${r(f100,1)} + ${r(c100,1)} + ${r(fi100,1)} + ${ash} + ${r(moisture,1)} ≈ ${r(p100+f100+c100+fi100+ash+moisture,1)} g`;
}

function chip(label, v, unit){ return `<div class="chip"><span>${label}</span><strong>${v} ${unit}</strong></div>`; }

// ===== Export CSV / XLSX =====
function toCSV(rows){ return rows.map(r=> r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n'); }
function downloadCSV(filename, csv){ const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

function tableRowsForIngredients(){
  const head = ['name','method','raw_g','yield','ret_protein','ret_fat','ret_carb','ret_fiber','ret_sodium'];
  const rows = [head];
  [...ingBody.querySelectorAll('tr')].forEach(tr=>{
    rows.push([
      tr.querySelector('.ing-name').value,
      tr.querySelector('.ing-method').value,
      tr.querySelector('.ing-raw').value,
      tr.querySelector('.ing-yield').value,
      tr.querySelector('.ing-ret-p').value,
      tr.querySelector('.ing-ret-f').value,
      tr.querySelector('.ing-ret-c').value,
      tr.querySelector('.ing-ret-fi').value,
      tr.querySelector('.ing-ret-na').value,
    ]);
  });
  return rows;
}

function rowsForResults(){
  // เรียกคำนวณล่าสุด
  compute();
  const dp = Number(roundDp.value||1);
  const textTotals = document.querySelectorAll('#totalsGrid .chip strong');
  const text100   = document.querySelectorAll('#convertGrid .chip strong');

  const rows = [];
  rows.push(['meta','serving_size_g', document.getElementById('servingSize').value]);
  rows.push(['meta','servings_per_pack', document.getElementById('servingsPerPack').value]);

  const totalsLabels = ['kcal_total','protein_total_g','fat_total_g','carb_total_g','fiber_total_g','sodium_total_mg','salt_total_g','final_weight_g'];
  totalsLabels.forEach((k,i)=> rows.push(['total', k, textTotals[i]?.textContent || '']));

  const labels100 = ['kcal_100g','protein_100g_g','fat_100g_g','carb_100g_g','fiber_100g_g','sodium_100g_mg','salt_100g_g'];
  labels100.forEach((k,i)=> rows.push(['per100g', k, text100[i+1]?.textContent || '']));

  const ss = document.getElementById('servingSize').value || 0;
  const labelsS = ['kcal_per_serving','protein_per_serving_g','fat_per_serving_g','carb_per_serving_g','fiber_per_serving_g','sodium_per_serving_mg','salt_per_serving_g'];
  labelsS.forEach((k,i)=> rows.push(['perserving', k, text100[8 + 1 + i]?.textContent || '']));

  return rows;
}

// CSV
document.getElementById('btnExportResults').addEventListener('click', ()=>{
  downloadCSV('nutrition_results.csv', toCSV(rowsForResults()));
});
document.getElementById('btnExportIngs').addEventListener('click', ()=>{
  downloadCSV('ingredients_input.csv', toCSV(tableRowsForIngredients()));
});

// XLSX (SheetJS)
function exportXLSX(filename, sheets){
  const wb = XLSX.utils.book_new();
  for(const {name, rows} of sheets){
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, name);
  }
  XLSX.writeFile(wb, filename);
}
document.getElementById('btnExportResultsXLSX').addEventListener('click', ()=>{
  exportXLSX('nutrition_results.xlsx', [{name:'results', rows: rowsForResults()}]);
});
document.getElementById('btnExportIngsXLSX').addEventListener('click', ()=>{
  exportXLSX('ingredients_input.xlsx', [{name:'ingredients', rows: tableRowsForIngredients()}]);
});
</script>
</body>
</html>
