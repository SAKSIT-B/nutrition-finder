<!DOCTYPE html>
<html lang="th" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nutrition Calculator | เครื่องคิดโภชนาการ</title>
  <meta name="description" content="คำนวณคุณค่าโภชนาการจากฐานข้อมูลไทย (ThaiFCD) บน GitHub Pages" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --radius:16px; --shadow:0 5px 18px rgba(15,23,42,.06); }
    :root,[data-theme="light"]{
      --bg:#f7fafc; --text:#0f172a; --muted:#5b677a; --card:#fff; --border:#e5e9f2;
      --accent:#2563eb; --accent-weak:#e6efff; --chip:#f1f5f9; --chip-border:#e2e8f0; --link:#0b5ad9; --overlay:rgba(15,23,42,.45);
    }
    [data-theme="dark"]{
      --bg:#0b1220; --text:#e7ecf5; --muted:#8ea0bd; --card:#121a2b; --border:#1f2a44;
      --accent:#74c0fc; --accent-weak:#0c2d4f; --chip:#0f1729; --chip-border:#223154; --link:#a6c8ff; --overlay:rgba(0,0,0,.6);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:var(--link)}
    .container{max-width:1100px;margin:0 auto;padding:0 20px}

    .topbar{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.7);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    [data-theme="dark"] .topbar{background:rgba(10,16,30,.6)}
    .topbar .wrap{display:flex;align-items:center;gap:12px;min-height:64px}
    .title{font-weight:800}
    .theme-btn,.menu-btn{border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .menu-btn{margin-right:6px}
    .credit-top{margin-left:auto;font-size:13px;color:var(--muted)}

    .overlay{position:fixed;inset:0;background:var(--overlay);opacity:0;pointer-events:none;transition:.25s;z-index:30}
    .sidebar{position:fixed;inset:0 0 0 auto;width:280px;max-width:80vw;background:var(--card);border-left:1px solid var(--border);transform:translateX(100%);transition:transform .25s;z-index:31;display:flex;flex-direction:column}
    .sidebar header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .sidebar nav{padding:10px 8px;display:flex;flex-direction:column;gap:6px}
    .navlink{padding:10px 12px;border-radius:12px;text-decoration:none;color:inherit;border:1px solid transparent}
    .navlink:hover{background:var(--chip);border-color:var(--chip-border)}
    .sidebar.show{transform:none}
    .overlay.show{opacity:1;pointer-events:auto}

    .panel{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:16px;box-shadow:var(--shadow);margin:16px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    label{font-size:14px;color:var(--muted)}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text)}
    .btn{border:0;background:var(--accent);color:#fff;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn-ghost{border:1px solid var(--border);background:var(--card);color:var(--text);padding:10px 14px;border-radius:12px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:var(--chip);border:1px solid var(--chip-border);border-radius:12px;padding:10px 12px;font-size:13px;display:flex;justify-content:space-between;gap:8px}
    .muted{color:var(--muted)}
    footer{border-top:1px solid var(--border);padding:18px 0 40px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="overlay" id="overlay"></div>
  <aside class="sidebar" id="sidebar">
    <header>
      <strong>เมนู</strong>
      <button class="theme-btn" id="closeSidebar">✕</button>
    </header>
    <nav>
      <a class="navlink" href="./">หน้าแรก</a>
      <a class="navlink" href="./calculator.html">เครื่องคิดโภชนาการ</a>
      <a class="navlink" href="#" onclick="alert('เวอร์ชันทดลองบน GitHub Pages');return false;">เกี่ยวกับ</a>
    </nav>
  </aside>

  <div class="topbar">
    <div class="container">
      <div class="wrap">
        <button class="menu-btn" id="openSidebar">☰</button>
        <div class="title">Nutrition Calculator</div>
        <div class="credit-top" id="creditTop"></div>
        <button class="theme-btn" id="themeToggle" title="สลับธีม">สลับธีม</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="panel">
      <h2 style="margin:0 0 10px">คำนวณโภชนาการจากฐานไทย</h2>
      <p class="muted" style="margin-top:0">เลือกวัตถุดิบจากฐาน <em>ingredients.json</em> (ThaiFCD) แล้วระบุปริมาณที่ต้องการ (g/ml)</p>

      <div class="row">
        <div>
          <label>ชื่อวัตถุดิบ</label>
          <input id="ingName" placeholder="ตัวอย่าง: กบ, ดิบ / ข้าวหอมมะลิ, สุก">
        </div>
        <div>
          <label>ปริมาณที่ต้องการคำนวณ</label>
          <div class="row">
            <input id="qty" type="number" min="1" value="100">
            <select id="qtyUnit"><option value="g">g</option><option value="ml">ml</option></select>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btnCalc">คำนวณ</button>
        <button class="btn-ghost" id="btnClear">ล้างค่า</button>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 10px">ผลลัพธ์</h3>
      <div id="resultMeta" class="muted" style="margin-bottom:10px"></div>

      <div class="row3">
        <div>
          <h4>Main nutrients</h4>
          <div class="chips" id="mainChips"></div>
        </div>
        <div>
          <h4>Minerals</h4>
          <div class="chips" id="mineralChips"></div>
        </div>
        <div>
          <h4>Vitamins</h4>
          <div class="chips" id="vitaminChips"></div>
        </div>
      </div>
      <div id="note" class="muted" style="margin-top:12px"></div>
    </div>
  </div>

  <footer>
    <div class="container">
      <div>
        ข้อมูลอ้างอิง: 
        <a href="https://thaifcd.anamai.moph.go.th/" target="_blank" rel="noopener">ThaiFCD (กรมอนามัย กระทรวงสาธารณสุข)</a>
        — จัดเก็บแบบสแตติกใน <code>data/ingredients.json</code> เพื่อใช้งานบน GitHub Pages
      </div>
      <div id="creditBottom" style="margin-top:6px"></div>
    </div>
  </footer>

<script>
/* ===== ธีม/Sidebar/เครดิต ===== */
const CREDIT_TEXT="ผู้จัดทำ: ครูศักดิ์สิทธิ์ บำรุง | ข้อมูลอ้างอิง: ThaiFCD (กรมอนามัย กระทรวงสาธารณสุข) • จัดเก็บใน data/ingredients.json เพื่อใช้งานบน GitHub Pages";
const root=document.documentElement;
function applyTheme(t){ root.setAttribute('data-theme',t); localStorage.setItem('nf-theme',t); }
function toggleTheme(){ const cur=root.getAttribute('data-theme')||'light'; applyTheme(cur==='light'?'dark':'light'); }
(function initTheme(){ applyTheme(localStorage.getItem('nf-theme')||'light'); })();
document.getElementById('themeToggle').addEventListener('click',toggleTheme);

const sidebar=document.getElementById('sidebar'), overlay=document.getElementById('overlay');
document.getElementById('openSidebar').addEventListener('click',()=>{sidebar.classList.add('show');overlay.classList.add('show')});
document.getElementById('closeSidebar').addEventListener('click',()=>{sidebar.classList.remove('show');overlay.classList.remove('show')});
overlay.addEventListener('click',()=>{sidebar.classList.remove('show');overlay.classList.remove('show')});
document.addEventListener('keydown',e=>{ if(e.key==='Escape'){sidebar.classList.remove('show');overlay.classList.remove('show')}});

window.addEventListener('DOMContentLoaded',()=>{
  const t=document.getElementById('creditTop'), b=document.getElementById('creditBottom');
  if(t) t.textContent=CREDIT_TEXT; if(b) b.textContent=CREDIT_TEXT;
});

/* ===== โหลดฐานข้อมูล ThaiFCD (static) ===== */
let THAI_DB=[];
async function loadIngredientsDB(){
  const res=await fetch('./data/ingredients.json');
  THAI_DB=await res.json();
}
function findItemByName(name){
  const key=String(name||'').trim().toLowerCase();
  return THAI_DB.find(x=>String(x.name||'').toLowerCase().includes(key));
}
function getNutrient(item,section,nutrient){
  const sec=(item.sections&&item.sections[section])||{};
  return sec[nutrient]||null;
}
function parseAmount(raw){
  if(raw==null) return null;
  const s=String(raw).trim(); if(!s) return null;
  if(/^</.test(s)||/^tr$/i.test(s)) return s; // เก็บข้อความพิเศษ
  const n=Number(s.replace(/,/g,'')); return isNaN(n)?s:n;
}
function scaleByBasis(item,value,targetAmount,targetUnit){
  if(typeof value!=='number') return value;
  const basis=item.basis||{}; const bAmt=Number(basis.amount||100); const bUnit=basis.unit||'g';
  if(bUnit!==targetUnit) return value; // ไม่แปลงข้ามหน่วย
  return value*(targetAmount/bAmt);
}
function chip(label,v,unit){ const val=(v==null||v==='')?'–':v; return `<div class="chip"><span>${label}</span><strong>${val} ${unit||''}</strong></div>`; }

async function calc(){
  if(THAI_DB.length===0) await loadIngredientsDB();
  const name=document.getElementById('ingName').value;
  const qty=Number(document.getElementById('qty').value||0);
  const unit=document.getElementById('qtyUnit').value;
  const item=findItemByName(name);
  const meta=document.getElementById('resultMeta');
  const main=document.getElementById('mainChips'), min=document.getElementById('mineralChips'), vit=document.getElementById('vitaminChips');
  main.innerHTML=min.innerHTML=vit.innerHTML=''; document.getElementById('note').textContent='';

  if(!item){ meta.textContent='ไม่พบรายการในฐานข้อมูล'; return; }
  meta.textContent = `${item.name} • basis: ${item.basis?.amount||100} ${item.basis?.unit||'g'} • ปริมาณที่คำนวณ: ${qty} ${unit}`;

  // แสดง Main
  for(const k of Object.keys(item.sections["Main nutrients"]||{})){
    const o=getNutrient(item,"Main nutrients",k);
    const v=parseAmount(o?.amount);
    const sv=scaleByBasis(item,v,qty,unit);
    main.innerHTML+=chip(k,sv,o?.unit);
  }
  // Minerals
  for(const k of Object.keys(item.sections["Minerals"]||{})){
    const o=getNutrient(item,"Minerals",k);
    const v=parseAmount(o?.amount);
    const sv=scaleByBasis(item,v,qty,unit);
    min.innerHTML+=chip(k,sv,o?.unit);
  }
  // Vitamins
  for(const k of Object.keys(item.sections["Vitamins"]||{})){
    const o=getNutrient(item,"Vitamins",k);
    const v=parseAmount(o?.amount);
    const sv=scaleByBasis(item,v,qty,unit);
    vit.innerHTML+=chip(k,sv,o?.unit);
  }

  document.getElementById('note').textContent='หมายเหตุ: ค่า “<0.1” หรือ “tr” ถูกเก็บเป็นข้อความตามต้นทาง ไม่คำนวณเพิ่ม';
}
document.getElementById('btnCalc').addEventListener('click',calc);
document.getElementById('btnClear').addEventListener('click',()=>{
  document.getElementById('ingName').value='';
  document.getElementById('qty').value=100;
  document.getElementById('qtyUnit').value='g';
  document.getElementById('mainChips').innerHTML='';
  document.getElementById('mineralChips').innerHTML='';
  document.getElementById('vitaminChips').innerHTML='';
  document.getElementById('resultMeta').textContent='';
  document.getElementById('note').textContent='';
});
</script>
</body>
</html>
