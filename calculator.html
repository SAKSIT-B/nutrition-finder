<!DOCTYPE html>
<html lang="th" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nutrition Calculator | คำนวณโภชนาการจากสูตรอาหาร</title>
  <meta name="description" content="คำนวณคุณค่าทางโภชนาการจากวัตถุดิบและน้ำหนักที่ระบุ รองรับ yield และ retention factors" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --radius:16px; --shadow:0 5px 18px rgba(15,23,42,.06); }
    :root,[data-theme="light"]{
      --bg:#f7fafc; --text:#0f172a; --muted:#5b677a; --card:#ffffff; --border:#e5e9f2;
      --accent:#2563eb; --accent-weak:#e6efff; --chip:#f1f5f9; --chip-border:#e2e8f0; --link:#0b5ad9;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --text:#e7ecf5; --muted:#8ea0bd; --card:#121a2b; --border:#1f2a44;
      --accent:#74c0fc; --accent-weak:#0c2d4f; --chip:#0f1729; --chip-border:#223154; --link:#a6c8ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}

    .topbar{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.7);backdrop-filter: blur(10px);border-bottom:1px solid var(--border)}
    [data-theme="dark"] .topbar{background:rgba(10,16,30,.6)}
    .container{max-width:1100px;margin:0 auto;padding:0 20px}
    .topbar .wrap{display:flex;align-items:center;gap:14px;min-height:64px}
    .logo{display:inline-flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    .logo .dot{width:12px;height:12px;border-radius:999px;background:var(--accent)}
    .title{font-weight:800;font-size:18px;letter-spacing:.2px}
    .credit-top{margin-left:auto;font-size:13px;color:var(--muted)}
    .theme-btn{margin-left:8px;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}

    .brandstrip{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin:10px 0}
    .brandstrip img{height:36px;object-fit:contain}
    [data-theme="dark"] .brandstrip img{filter:brightness(1) contrast(1.05)}

    header.hero{padding:16px 0 10px}
    header.hero h1{font-size:clamp(24px,3.2vw,38px);margin:6px 0 8px}
    header.hero .sub{margin:0;color:var(--muted)}

    .card{background:var(--card);border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow)}
    .section{padding:14px 16px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input, select, textarea{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);
    }
    label{font-size:13px;color:var(--muted)}
    .btn{border:1px solid var(--border);background:var(--card);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--accent);color:#fff;border:0}
    .table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;background:var(--card)}
    .table th{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    .chip{background:var(--chip);border:1px solid var(--chip-border);border-radius:12px;padding:10px 12px;font-size:13px;display:flex;justify-content:space-between;gap:8px}
    .nutri-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    footer{border-top:1px solid var(--border);padding:18px 0 40px;color:var(--muted);font-size:13px;margin-top:26px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div class="wrap">
        <a class="logo" href="index.html" aria-label="Home">
          <span class="dot"></span>
          <span class="title">Nutrition Calculator</span>
        </a>
        <div class="credit-top" id="creditTop"></div>
        <button class="theme-btn" id="themeToggle" title="สลับธีม">สลับธีม</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="brandstrip">
      <img id="logo1" alt="สถาบัน 1">
      <img id="logo2" alt="สถาบัน 2">
      <img id="logo3" alt="สถาบัน 3">
    </div>

    <header class="hero">
      <h1>คำนวณโภชนาการจากสูตรอาหาร</h1>
      <p class="sub">ใส่รายการวัตถุดิบและน้ำหนัก (กรัม) ระบบจะคำนวณสารอาหารรวม พร้อมปรับค่า per 100 g และ per serving<br>
        รองรับ <em>yield factor</em> และ <em>retention factor</em> ต่อสารอาหาร</p>
      <div class="row">
        <a class="btn" href="index.html">← กลับหน้า ค้นหาข้อมูลสำเร็จรูป (OpenFoodFacts)</a>
      </div>
    </header>

    <!-- การตั้งค่า -->
    <div class="card section" style="margin-bottom:14px">
      <div class="grid cols-3">
        <div>
          <label>น้ำหนักสุทธิหลังปรุง (g) – ถ้าคำนวณเป็น “ทั้งจาน”</label>
          <input id="finalWeight" type="number" step="0.1" placeholder="เช่น 500">
        </div>
        <div>
          <label>ขนาดหนึ่งหน่วยบริโภค (serving size, g)</label>
          <input id="servingSize" type="number" step="0.1" placeholder="เช่น 150">
        </div>
        <div>
          <label>จำนวนหน่วยต่อบรรจุภัณฑ์</label>
          <input id="servingsPerPack" type="number" step="0.1" placeholder="เช่น 3">
        </div>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div>
          <label>ตำแหน่งทศนิยม (การปัด)</label>
          <select id="roundDp">
            <option value="0">0</option>
            <option value="1" selected>1</option>
            <option value="2">2</option>
          </select>
        </div>
        <div>
          <label>ฐานข้อมูลวัตถุดิบ (เลือก/พิมพ์ค้น)</label>
          <input id="searchIngredient" type="text" placeholder="พิมพ์เพื่อค้น เช่น ข้าวหุงสุก, chicken, น้ำปลา">
        </div>
        <div class="row">
          <button class="btn" id="btnAdd">+ เพิ่มแถว</button>
          <button class="btn" id="btnClear">ล้างตาราง</button>
          <button class="btn" id="btnSample">ใส่ตัวอย่าง</button>
        </div>
      </div>
      <p class="muted" style="margin-top:8px">หมายเหตุ: ฐานข้อมูลตัวอย่างเป็น “ค่าต่อ 100 g (ดิบ)” คุณสามารถแก้/ขยายได้ในสคริปต์ หรือแยกเป็นไฟล์ JSON ก็ได้</p>
    </div>

    <!-- ตารางวัตถุดิบ -->
    <div class="card section" style="margin-bottom:14px">
      <table class="table" id="ingTable">
        <thead>
          <tr>
            <th style="width:22%">ชื่อวัตถุดิบ</th>
            <th style="width:12%">น้ำหนักดิบ (g)</th>
            <th style="width:12%">Yield factor</th>
            <th style="width:12%">Retention โปรตีน</th>
            <th style="width:12%">Retention ไขมัน</th>
            <th style="width:12%">Retention คาร์บ</th>
            <th style="width:12%">Retention ใยอาหาร</th>
            <th style="width:6%"></th>
          </tr>
        </thead>
        <tbody id="ingBody"></tbody>
      </table>
    </div>

    <!-- ผลลัพธ์ -->
    <div class="card section">
      <div class="grid cols-2">
        <div>
          <h3 style="margin:6px 0">ผลรวมทั้งจาน (หลังปรับ yield & retention)</h3>
          <div class="nutri-grid" id="totalsGrid"></div>
        </div>
        <div>
          <h3 style="margin:6px 0">แปลงผลลัพธ์</h3>
          <div class="nutri-grid" id="convertGrid"></div>
        </div>
      </div>
    </div>

    <!-- ตารางตรวจทานมวลรวม -->
    <div class="card section" style="margin-top:14px">
      <h3 style="margin:6px 0">ตรวจทานมวลรวม (ใกล้ 100 g ต่อ 100 g)</h3>
      <div class="muted" id="massCheck"></div>
    </div>

  </div>

  <footer>
    <div class="container">
      <div>อ้างอิงการคำนวณ: Atwater factors (พลังงาน), แนวคิด yield/retention สำหรับการปรุงอาหาร</div>
      <div id="creditBottom"></div>
    </div>
  </footer>

<script>
/* ====== ตั้งค่าเครดิต/โลโก้ให้เหมือนหน้าแรก ====== */
const CREDIT_TEXT = "ผู้จัดทำ: ครูศักดิ์สิทธิ์ บำรุง | แผนกวิชาอาหารและโภชนาการ วิทยาลัยอาชีวศึกษาสุโขทัย | © 2025";
const LOGOS = ["assets/img/logo1.png","assets/img/logo2.png","assets/img/logo3.png"];

const root = document.documentElement;
function applyTheme(t){ root.setAttribute('data-theme', t); localStorage.setItem('nf-theme', t); }
function toggleTheme(){ const cur = root.getAttribute('data-theme')||'light'; applyTheme(cur==='light'?'dark':'light'); }
(function initTheme(){ applyTheme(localStorage.getItem('nf-theme')||'light'); })();
document.getElementById('themeToggle').addEventListener('click', toggleTheme);

function safeSetLogo(id, src){
  const el = document.getElementById(id);
  if(!el) return;
  el.onerror = () => { el.style.display = 'none'; };
  if(src) el.src = src;
}
window.addEventListener('DOMContentLoaded', ()=>{
  const top = document.getElementById('creditTop');
  const bottom = document.getElementById('creditBottom');
  if(top) top.textContent = CREDIT_TEXT;
  if(bottom) bottom.textContent = CREDIT_TEXT;
  const [l1,l2,l3] = LOGOS;
  safeSetLogo('logo1', l1); safeSetLogo('logo2', l2); safeSetLogo('logo3', l3);
});

/* ====== ฐานข้อมูลตัวอย่าง (ต่อ 100 g, วัตถุดิบดิบ) ======
   หมายเหตุ: แก้/เพิ่มได้ตามต้องการ หรือภายหลังแยกไฟล์ ingredients.json แล้ว fetch ก็ได้ */
const DB = [
  { name: "ข้าวสารหอมมะลิ (ดิบ)", protein:7.1, fat:0.6, carbs:78.2, fiber:1.0, sodium_mg:5 },
  { name: "ข้าวสวยหุงสุก", protein:2.6, fat:0.3, carbs:28.0, fiber:0.4, sodium_mg:2 },
  { name: "อกไก่ดิบ", protein:21.0, fat:2.5, carbs:0.0, fiber:0.0, sodium_mg:70 },
  { name: "น้ำปลา", protein:0.0, fat:0.0, carbs:0.0, fiber:0.0, sodium_mg:7000 }, // 7,000 mg/100 g ตัวอย่าง
  { name: "น้ำตาลทราย", protein:0.0, fat:0.0, carbs:100.0, fiber:0.0, sodium_mg:0 },
  { name: "น้ำมันพืช", protein:0.0, fat:100.0, carbs:0.0, fiber:0.0, sodium_mg:0 },
];

/* ====== Utilities ====== */
const $ = (s)=>document.querySelector(s);
function r(v, dp){ const n = Number(v); if(!isFinite(n)) return 0; const f = Math.pow(10,dp); return Math.round(n*f)/f; }
function kcal(p, c, f, sugarAlcohol=0, fiber=0){
  // Atwater: 4/4/9 (อาจนับน้ำตาลแอลกอฮอล์ ~2.4 kcal/g, ใยอาหาร 0–2 kcal/g แล้วแต่นโยบาย; ที่นี่ไม่นับพลังงานจาก fiber)
  return (4*p) + (4*c) + (9*f) + (2.4*sugarAlcohol);
}
function saltFromSodium_g(sodium_g){ return sodium_g * 2.5; }

/* ====== สถานะตาราง ====== */
const ingBody = $("#ingBody");
const searchBox = $("#searchIngredient");
const roundDp = $("#roundDp");
const finalWeight = $("#finalWeight");
const servingSize = $("#servingSize");
const servingsPerPack = $("#servingsPerPack");
const totalsGrid = $("#totalsGrid");
const convertGrid = $("#convertGrid");
const massCheck = $("#massCheck");

function addRow(prefill){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>
      <input class="ing-name" list="ing-list" placeholder="ชื่อวัตถุดิบ" value="${prefill?.name||""}">
      <datalist id="ing-list">
        ${DB.map(d=>`<option value="${d.name}">`).join("")}
      </datalist>
    </td>
    <td><input class="ing-raw" type="number" step="0.1" placeholder="g" value="${prefill?.raw||""}"></td>
    <td><input class="ing-yield" type="number" step="0.01" placeholder="เช่น 0.85" value="${prefill?.yld??1}"></td>
    <td><input class="ing-ret-p" type="number" step="0.01" placeholder="เช่น 0.95" value="${prefill?.rp??1}"></td>
    <td><input class="ing-ret-f" type="number" step="0.01" placeholder="เช่น 1.00" value="${prefill?.rf??1}"></td>
    <td><input class="ing-ret-c" type="number" step="0.01" placeholder="เช่น 0.90" value="${prefill?.rc??1}"></td>
    <td><input class="ing-ret-fi" type="number" step="0.01" placeholder="เช่น 0.90" value="${prefill?.rfi??1}"></td>
    <td><button class="btn btn-del">ลบ</button></td>
  `;
  ingBody.appendChild(tr);
  tr.querySelector(".btn-del").addEventListener("click", ()=>{ tr.remove(); compute(); });
  ["ing-name","ing-raw","ing-yield","ing-ret-p","ing-ret-f","ing-ret-c","ing-ret-fi"].forEach(cls=>{
    tr.querySelector("."+cls).addEventListener("input", compute);
  });
}

$("#btnAdd").addEventListener("click", ()=> addRow());
$("#btnClear").addEventListener("click", ()=>{ ingBody.innerHTML=""; compute(); });
$("#btnSample").addEventListener("click", ()=>{
  ingBody.innerHTML="";
  addRow({name:"ข้าวสวยหุงสุก", raw:300, yld:1.00, rp:1.00, rf:1.00, rc:1.00, rfi:1.00});
  addRow({name:"อกไก่ดิบ", raw:200, yld:0.75, rp:0.95, rf:1.00, rc:0.90, rfi:0.90}); // ตัวอย่าง: สุกหดตัว, โปรตีนคงเหลือ 95%
  addRow({name:"น้ำปลา", raw:15, yld:1.00, rp:1.00, rf:1.00, rc:1.00, rfi:1.00});
  finalWeight.value = 600; servingSize.value = 150; servingsPerPack.value = 4;
  compute();
});

[roundDp, finalWeight, servingSize, servingsPerPack].forEach(el=> el.addEventListener("input", compute));

/* ค้นหาอัตโนมัติ */
searchBox.addEventListener("change", ()=>{
  const val = searchBox.value.trim();
  if(!val) return;
  const hit = DB.find(d => d.name === val);
  if(hit){ addRow({name:hit.name, raw:100}); }
  else { addRow({name:val, raw:100}); }
  searchBox.value="";
  compute();
});

/* ====== แกนคำนวณ ======
   1) ดึงค่าต่อ 100 g ของวัตถุดิบ (โปรตีน/ไขมัน/คาร์บ/ใย/โซเดียม)
   2) แปลงตามน้ำหนักดิบที่ใช้จริง
   3) ปรับตาม yield (น้ำหนักหลังปรุง) และ retention ต่อสารอาหาร
   4) รวมทุกวัตถุดิบ => ได้ "ทั้งจาน"
   5) แปลงเป็นต่อ 100 g (ด้วย finalWeight) และต่อ serving (ด้วย servingSize)
*/
function compute(){
  const dp = Number(roundDp.value||1);

  let totalProtein=0, totalFat=0, totalCarb=0, totalFiber=0, totalSodium_mg=0;
  let totalCookedWeight = 0;

  [...ingBody.querySelectorAll("tr")].forEach(tr=>{
    const name = tr.querySelector(".ing-name").value.trim();
    const raw = Number(tr.querySelector(".ing-raw").value||0);
    const yld = Number(tr.querySelector(".ing-yield").value||1);
    const rp  = Number(tr.querySelector(".ing-ret-p").value||1);
    const rf  = Number(tr.querySelector(".ing-ret-f").value||1);
    const rc  = Number(tr.querySelector(".ing-ret-c").value||1);
    const rfi = Number(tr.querySelector(".ing-ret-fi").value||1);

    if(!raw || raw<=0) return;

    const base = DB.find(d=>d.name===name);
    const P100 = base?.protein??0, F100 = base?.fat??0, C100 = base?.carbs??0, FI100 = base?.fiber??0, NA100_mg = base?.sodium_mg??0;

    // ปริมาณสารอาหารจากน้ำหนักดิบที่ใช้จริง (หน่วย g; โซเดียมเป็น mg)
    const p = (P100/100) * raw;    // g
    const f = (F100/100) * raw;    // g
    const c = (C100/100) * raw;    // g
    const fi= (FI100/100) * raw;   // g
    const na_mg = (NA100_mg/100) * raw; // mg

    // ปรับผลจากการปรุง: yield (ส่งผลต่อน้ำหนักสุทธิ) + retention ต่อสารอาหาร
    const cookedWeight = raw * yld;
    totalCookedWeight += cookedWeight;

    totalProtein    += p * rp;
    totalFat        += f * rf;
    totalCarb       += c * rc;
    totalFiber      += fi * rfi;
    totalSodium_mg  += na_mg; // โซเดียมมักไม่หายไปมากในการปรุงทั่วไป (คงค่าไว้ หรือจะตั้ง retention เพิ่มก็ได้)
  });

  // ถ้าไม่ได้กำหนด finalWeight ให้ใช้ totalCookedWeight เป็นค่าอ้างอิง
  const FW = Number(finalWeight.value) > 0 ? Number(finalWeight.value) : totalCookedWeight;
  const SS = Number(servingSize.value) || 0;

  // ทั้งจาน (หลังปรับ)
  const totalEnergy = kcal(totalProtein, totalCarb, totalFat);
  const totalSalt_g = saltFromSodium_g(totalSodium_mg/1000);

  // per 100 g
  const factor100 = FW>0 ? (100/FW) : 0;
  const p100 = totalProtein*factor100, f100 = totalFat*factor100, c100 = totalCarb*factor100, fi100 = totalFiber*factor100;
  const na100_mg = totalSodium_mg*factor100;
  const salt100_g = totalSalt_g*factor100;
  const kcal100 = kcal(p100, c100, f100);

  // per serving
  const factorS = (SS>0 && FW>0) ? (SS/FW) : 0;
  const ps = totalProtein*factorS, fs=totalFat*factorS, cs=totalCarb*factorS, fis=totalFiber*factorS;
  const nas_mg = totalSodium_mg*factorS;
  const salts_g = totalSalt_g*factorS;
  const kcals = kcal(ps, cs, fs);

  // Render รวมทั้งจาน
  totalsGrid.innerHTML = [
    chip("พลังงานรวม", r(totalEnergy, dp), "kcal"),
    chip("โปรตีนรวม", r(totalProtein, dp), "g"),
    chip("ไขมันรวม", r(totalFat, dp), "g"),
    chip("คาร์บรวม", r(totalCarb, dp), "g"),
    chip("ใยอาหารรวม", r(totalFiber, dp), "g"),
    chip("โซเดียมรวม", r(totalSodium_mg, dp), "mg"),
    chip("เกลือรวม", r(totalSalt_g, dp), "g"),
    chip("น้ำหนักสุทธิหลังปรุง", r(FW, dp), "g")
  ].join("");

  // Render per 100 g และ per serving
  convertGrid.innerHTML = [
    `<div class="chip"><strong>ต่อ 100 g</strong><span></span></div>`,
    chip("พลังงาน", r(kcal100, dp), "kcal"),
    chip("โปรตีน", r(p100, dp), "g"),
    chip("ไขมัน", r(f100, dp), "g"),
    chip("คาร์บ", r(c100, dp), "g"),
    chip("ใยอาหาร", r(fi100, dp), "g"),
    chip("โซเดียม", r(na100_mg, dp), "mg"),
    chip("เกลือ", r(salt100_g, dp), "g"),
    `<div class="chip"><strong>ต่อ serving (${r(SS,dp)} g)</strong><span></span></div>`,
    chip("พลังงาน", r(kcals, dp), "kcal"),
    chip("โปรตีน", r(ps, dp), "g"),
    chip("ไขมัน", r(fs, dp), "g"),
    chip("คาร์บ", r(cs, dp), "g"),
    chip("ใยอาหาร", r(fis, dp), "g"),
    chip("โซเดียม", r(nas_mg, dp), "mg"),
    chip("เกลือ", r(salts_g, dp), "g")
  ].join("");

  // ตรวจมวลรวมต่อ 100 g (โดยประมาณ)
  const ash = 2; // สมมุติให้มีเถ้า ~2 g/100g (แก้เองได้ตามอาหาร)
  const moisture = 100 - (p100 + f100 + c100 + fi100 + ash);
  massCheck.textContent = `โปรตีน + ไขมัน + คาร์บ + ใยอาหาร + เถ้า(สมมุติ ${ash} g) + ความชื้น(คำนวณ) = `
    + `${r(p100,1)} + ${r(f100,1)} + ${r(c100,1)} + ${r(fi100,1)} + ${ash} + ${r(moisture,1)} ≈ ${r(p100+f100+c100+fi100+ash+moisture,1)} g`;
}

function chip(label, v, unit){ return `<div class="chip"><span>${label}</span><strong>${v} ${unit}</strong></div>`; }

compute(); // เริ่มต้น
</script>
</body>
</html>
