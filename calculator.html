<!DOCTYPE html>
<html lang="th" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nutrition Calculator ‚Ä¢ Dashboard</title>
<meta name="description" content="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö yield/retention ‚Ä¢ Export CSV/XLSX" />

<!-- Fonts & Libs -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

<style>
:root{
  --bg:#F6F8FC; --card:#FFFFFF; --text:#111827; --muted:#6B7280; --border:#E5E9F2;
  --accent:#0EA5E9; --danger:#EF4444; --chip:#F3F6FB; --chip-border:#E5EBF4;
  --radius:20px; --shadow:0 14px 36px rgba(17,24,39,.10);
}
[data-theme="dark"]{
  --bg:#0B1220; --card:#111827; --text:#E6EAF2; --muted:#9AA3B2; --border:#1E2637;
  --accent:#60C6F2; --danger:#F87171; --chip:#0F172A; --chip-border:#21304F;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}

/* ===== Overlay Sidebar ===== */
.layout{ display:block; min-height:100vh; }
.aside.drawer{
  position: fixed; inset: 0 auto 0 0;
  width: 280px; max-width: 86vw;
  background:#111827; color:#cbd5e1;
  display:flex; flex-direction:column; gap:14px;
  padding:18px 16px;
  transform: translateX(-102%);
  transition: transform .28s ease;
  z-index: 1001;
  box-shadow: 8px 0 30px rgba(0,0,0,.24);
}
.aside.drawer .brand{display:flex;align-items:center;gap:10px}
.aside.drawer .brand .dot{width:12px;height:12px;border-radius:999px;background:var(--accent)}
.aside.drawer .brand .name{ color:#fff; font-weight:800 }
.aside.drawer .menu a{ display:flex; gap:10px; align-items:center; padding:10px 12px; border-radius:14px; color:#cbd5e1; text-decoration:none; font-weight:600 }
.aside.drawer .menu a.active,.aside.drawer .menu a:hover{ background:rgba(255,255,255,.08); color:#fff }
.aside.drawer .menu a .ico{ width:28px; height:28px; display:inline-grid; place-items:center; border-radius:10px; background:rgba(255,255,255,.06); color:#e2e8f0; font-size:15px }
.aside.drawer .menu a.active .ico{ background:rgba(255,255,255,.12); color:#fff }
.aside.drawer .footer-mini{margin-top:auto;font-size:12px;color:#94a3b8}

body.sb-open .aside.drawer{ transform: translateX(0); }
body.sb-open{ overflow:hidden; }
.backdrop{ position:fixed; inset:0; background:rgba(15,23,42,.45); backdrop-filter:blur(2px); opacity:0; transition:opacity .25s ease; z-index:1000 }
body.sb-open .backdrop{ opacity:1 } .backdrop[hidden]{ display:none }
#sbToggle{ min-width:44px }

/* Topbar & main */
.topbar{position:sticky;top:0;z-index:9;background:transparent;backdrop-filter: blur(6px);margin-bottom:10px}
.container{max-width:1100px;margin:0 auto;padding:0 20px}
.topbar .wrap{display:flex;align-items:center;gap:10px;min-height:66px}
.credit-top{margin-left:auto;font-size:13px;color:var(--muted)}
.theme-btn,.btn{border:1px solid var(--border);background:var(--card);color:var(--text);padding:12px 14px;border-radius:14px;cursor:pointer;text-decoration:none;font-weight:700}
.btn.primary{background:var(--accent);color:#fff;border:0}
.btn.danger{background:var(--danger);color:#fff;border:0}
.btn{transition:transform .15s ease, box-shadow .15s ease} .btn:hover{transform:translateY(-1px)}
.btn, .theme-btn { position: relative; overflow: hidden; }
.ripple{position:absolute;transform:scale(0);border-radius:50%;background:rgba(255,255,255,.45);animation:ripple .6s linear;pointer-events:none}
@keyframes ripple{to{transform:scale(4);opacity:0}}

.main{padding:10px 0 24px}
.brandstrip{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin:6px 0 12px}
.brandstrip img{height:40px;object-fit:contain}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
.section{padding:16px 16px}
.hero h1{font-size:clamp(26px,3.2vw,40px);margin:0 0 6px}
.sub{margin:0;color:var(--muted)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.grid{display:grid;gap:12px}
.cols-3{grid-template-columns:1fr 1fr 1fr}
.cols-2{grid-template-columns:1fr 1fr}
input,select{width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);background:var(--card);color:var(--text)}
.table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:16px;overflow:auto}
.table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle;background:var(--card)}
.table th{font-size:12px;color:var(--muted)}
.chip{background:var(--chip);border:1px solid var(--chip-border);border-radius:12px;padding:10px 12px;font-size:13px;display:flex;justify-content:space-between;gap:8px}
.nutri-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.muted{color:var(--muted)}
footer{border-top:1px solid var(--border);padding:18px 0 40px;color:var(--muted);font-size:13px}
#toast{position:fixed;right:16px;bottom:16px;z-index:9999;display:none}
.toast{background:#111827;color:#fff;padding:10px 14px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);margin-top:8px;opacity:.98}
@media (prefers-reduced-motion: reduce){ *{transition:none !important; animation:none !important} }
</style>
</head>
<body>
<div class="layout">

  <!-- Sidebar (Overlay Drawer) -->
  <aside class="aside drawer" id="sidebar" tabindex="-1" aria-hidden="true">
    <div class="brand"><span class="dot"></span> <span class="name">Nutrition Tools</span></div>
    <nav class="menu">
      <a href="index.html" title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
        <span class="ico">üîé</span><span class="label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
      </a>
      <a class="active" href="calculator.html" title="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£">
        <span class="ico">üßÆ</span><span class="label">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</span>
      </a>
      <a href="https://world.openfoodfacts.org/" target="_blank" rel="noopener" title="OpenFoodFacts">
        <span class="ico">üåê</span><span class="label">OpenFoodFacts</span>
      </a>
    </nav>
    <div class="footer-mini">¬© 2025 SAKSIT BAMRUNG-Food & Nutrition@STVC ‚Ä¢ Better, Faster, Cheaper</div>
  </aside>

  <div class="backdrop" id="sbBackdrop" hidden></div>

  <main class="main">
    <div id="toast"></div>

    <div class="topbar">
      <div class="container">
        <div class="wrap">
          <button class="btn" id="sbToggle" title="‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π (Ctrl+B)">‚ò∞</button>
          <div class="credit-top" id="creditTop"></div>
          <button class="theme-btn" id="themeToggle">‡∏™‡∏•‡∏±‡∏ö‡∏ò‡∏µ‡∏°</button>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="brandstrip">
        <img id="logo1" alt="‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô 1"><img id="logo2" alt="‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô 2"><img id="logo3" alt="‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô 3">
      </div>

      <div class="card section hero">
        <h1>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>
        <p class="sub">‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏î‡∏¥‡∏ö (g) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏ß‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ <strong>‡∏ï‡πà‡∏≠ 100 g</strong> ‡πÅ‡∏•‡∏∞ <strong>‡∏ï‡πà‡∏≠ serving</strong> ¬∑ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö <em>yield</em> ‡πÅ‡∏•‡∏∞ <em>retention</em> ‡∏ï‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
        <div class="row" style="margin-top:8px">
          <a class="btn" href="index.html">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</a>
          <a class="btn" href="data/ingredients.json" target="_blank" rel="noopener">‡∏î‡∏π‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (JSON)</a>
          <button class="btn" id="btnExportResults">Export ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (CSV)</button>
          <button class="btn" id="btnExportResultsXLSX">Export ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (XLSX)</button>
          <button class="btn" id="btnExportIngs">Export ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (CSV)</button>
          <button class="btn" id="btnExportIngsXLSX">Export ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (XLSX)</button>
        </div>
      </div>

      <div class="card section" style="margin-top:12px">
        <div class="grid cols-3">
          <div><label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ (g)</label><input id="servingSize" type="number" step="0.1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 150"></div>
          <div><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</label><input id="servingsPerPack" type="number" step="0.1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3"></div>
          <div><label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° (‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏î)</label><select id="roundDp"><option value="0">0</option><option value="1" selected>1</option><option value="2">2</option></select></div>
        </div>

        <div class="grid cols-3" style="margin-top:10px">
          <div><label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label><input id="searchIngredient" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢‡∏´‡∏∏‡∏á‡∏™‡∏∏‡∏Å, chicken, ‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤" list="ing-list"></div>
          <div class="row">
            <button class="btn" id="btnAdd">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
            <button class="btn" id="btnClear">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
            <button class="btn" id="btnSample">‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
          </div>
        </div>
        <p class="muted" style="margin-top:8px">‡∏û‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏ò‡∏¥‡∏ï/‡∏™‡∏≠‡∏ô ‚Äî ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ</p>
      </div>

      <datalist id="ing-list"></datalist>

      <div class="card section" style="margin-top:12px;overflow:auto">
        <table class="table" id="ingTable">
          <thead>
            <tr>
              <th style="min-width:200px">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</th>
              <th style="min-width:150px">‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏£‡∏∏‡∏á (‡∏û‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï)</th>
              <th style="min-width:120px">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏î‡∏¥‡∏ö (g)</th>
              <th style="min-width:110px">Yield</th>
              <th style="min-width:130px">Ret. ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</th>
              <th style="min-width:120px">Ret. ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô</th>
              <th style="min-width:130px">Ret. ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö</th>
              <th style="min-width:140px">Ret. ‡πÉ‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£</th>
              <th style="min-width:130px">Ret. ‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°</th>
              <th style="min-width:60px"></th>
            </tr>
          </thead>
          <tbody id="ingBody"></tbody>
        </table>
      </div>

      <div class="card section" style="margin-top:12px">
        <div class="grid cols-2">
          <div>
            <h3 style="margin:6px 0">‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏ô (‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö yield & retention)</h3>
            <div class="nutri-grid" id="totalsGrid"></div>
          </div>
          <div>
            <h3 style="margin:6px 0">‡πÅ‡∏õ‡∏•‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h3>
            <div class="nutri-grid" id="convertGrid"></div>
          </div>
        </div>
      </div>

      <div class="card section" style="margin-top:12px">
        <h3 style="margin:6px 0">‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡∏°‡∏ß‡∏•‡∏£‡∏ß‡∏° (‡πÉ‡∏Å‡∏•‡πâ 100 g ‡∏ï‡πà‡∏≠ 100 g)</h3>
        <div class="muted" id="massCheck"></div>
      </div>

      <footer style="margin-top:18px">
        <div>‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: Atwater factors (‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô) + ‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î yield/retention</div>
        <div id="creditBottom"></div>
      </footer>
    </div>
  </main>
</div>

<script>
/* ===== Credit/Logo/Theme ===== */
const CREDIT_TEXT="‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥: ‡∏Ñ‡∏£‡∏π‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏ö‡∏≥‡∏£‡∏∏‡∏á | ‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢ | ¬© 2025";
const LOGOS=["assets/img/logo1.png","assets/img/logo2.png","assets/img/logo3.png"];
const root=document.documentElement;
function applyTheme(t){root.setAttribute('data-theme',t);localStorage.setItem('nf-theme',t);}
function toggleTheme(){const cur=localStorage.getItem('nf-theme')||'light';applyTheme(cur==='light'?'dark':'light');}
(function(){applyTheme(localStorage.getItem('nf-theme')||'light');})();
document.getElementById('themeToggle').addEventListener('click',toggleTheme);
function safeSetLogo(id,src){const el=document.getElementById(id);if(!el)return;el.onerror=()=>{el.style.display='none'};if(src)el.src=src;}
function attachRipple(sel='.btn, .theme-btn'){document.querySelectorAll(sel).forEach(b=>{
  b.addEventListener('click',function(e){const r=document.createElement('span');const d=Math.max(this.clientWidth,this.clientHeight);
    r.className='ripple';r.style.width=r.style.height=d+'px';const rect=this.getBoundingClientRect();
    r.style.left=(e.clientX-rect.left-d/2)+'px';r.style.top=(e.clientY-rect.top-d/2)+'px';this.appendChild(r);setTimeout(()=>r.remove(),600);});});}
function showToast(msg){const box=document.getElementById('toast');const el=document.createElement('div');el.className='toast';el.textContent=msg;box.appendChild(el);box.style.display='block';
  setTimeout(()=>{el.style.opacity='0';el.style.transform='translateY(6px)';},1600);
  setTimeout(()=>{el.remove();if(!box.children.length) box.style.display='none';},2100);}

/* ===== Overlay Sidebar Control ===== */
(function overlaySidebar(){
  const body=document.body, sidebar=document.getElementById('sidebar'), backdrop=document.getElementById('sbBackdrop'), toggleBtn=document.getElementById('sbToggle');
  const KEY='nf-sidebar-open';
  function openSB(){ body.classList.add('sb-open'); backdrop.hidden=false; sidebar.setAttribute('aria-hidden','false'); toggleBtn?.setAttribute('aria-expanded','true'); sidebar.focus({preventScroll:true}); try{localStorage.setItem(KEY,'1')}catch(e){} }
  function closeSB(){ body.classList.remove('sb-open'); sidebar.setAttribute('aria-hidden','true'); toggleBtn?.setAttribute('aria-expanded','false'); setTimeout(()=>{backdrop.hidden=true},200); try{localStorage.setItem(KEY,'0')}catch(e){} }
  function toggleSB(){ body.classList.contains('sb-open')?closeSB():openSB(); }
  try{ localStorage.getItem(KEY)==='1'?openSB():closeSB(); }catch(e){ closeSB(); }
  toggleBtn?.addEventListener('click',e=>{e.stopPropagation();toggleSB();});
  backdrop?.addEventListener('click',closeSB);
  document.addEventListener('click',e=>{ if(!body.classList.contains('sb-open')) return; const t=e.target; if(sidebar.contains(t)||toggleBtn?.contains(t)) return; closeSB(); }, true);
  window.addEventListener('keydown',e=>{ if(e.key==='Escape'&&body.classList.contains('sb-open')){e.preventDefault();closeSB();} if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='b'){e.preventDefault();toggleSB();} });
  window.addEventListener('resize',()=>{ if(body.classList.contains('sb-open')) closeSB(); });
})();

/* ===== Load DB (JSON/CSV) ===== */
let DB=[];
async function loadDB(){
  try{const r=await fetch('data/ingredients.json',{cache:'no-store'});if(r.ok){DB=await r.json();return;}}catch(e){}
  try{const r2=await fetch('data/ingredients.csv',{cache:'no-store'});if(r2.ok){const txt=await r2.text();DB=parseCSV(txt);return;}}catch(e){}
  // fallback demo
  DB=[{name:'‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢‡∏´‡∏∏‡∏á‡∏™‡∏∏‡∏Å',state:'cooked',protein:2.6,fat:0.3,carbs:28,fiber:0.4,sodium_mg:2},
      {name:'‡∏≠‡∏Å‡πÑ‡∏Å‡πà‡∏î‡∏¥‡∏ö',state:'raw',protein:21,fat:2.5,carbs:0,fiber:0,sodium_mg:70},
      {name:'‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤',state:'liquid',protein:0,fat:0,carbs:0,fiber:0,sodium_mg:7000}];
}
function parseCSV(csv){const lines=csv.trim().split(/\r?\n/);const head=lines.shift().split(',');const id=k=>head.indexOf(k);const out=[];
  for(const l of lines){if(!l.trim())continue;const c=l.split(',');
    out.push({name:(c[id('name')]||'').trim(),state:(c[id('state')]||'').trim(),protein:Number(c[id('protein')]||0),
      fat:Number(c[id('fat')]||0),carbs:Number(c[id('carbs')]||0),fiber:Number(c[id('fiber')]||0),sodium_mg:Number(c[id('sodium_mg')]||0)});} return out; }

/* ===== Presets ===== */
const PRESETS={
  '‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏î‡∏¥‡∏ö':{yld:1.00,rp:1.00,rf:1.00,rc:1.00,rfi:1.00,rna:1.00},
  '‡∏ï‡πâ‡∏°/‡∏•‡∏ß‡∏Å/‡∏ï‡∏∏‡πã‡∏ô':{yld:0.95,rp:0.95,rf:0.98,rc:0.95,rfi:0.90,rna:1.00},
  '‡∏ô‡∏∂‡πà‡∏á':{yld:0.98,rp:0.97,rf:0.99,rc:0.97,rfi:0.92,rna:1.00},
  '‡∏ú‡∏±‡∏î':{yld:0.90,rp:0.95,rf:1.05,rc:0.95,rfi:0.90,rna:1.00},
  '‡∏ó‡∏≠‡∏î':{yld:0.80,rp:0.93,rf:1.10,rc:0.90,rfi:0.85,rna:1.00},
  '‡∏¢‡πà‡∏≤‡∏á/‡∏≠‡∏ö':{yld:0.80,rp:0.95,rf:1.00,rc:0.95,rfi:0.90,rna:1.00}
};

/* ===== DOM & helpers ===== */
const $=s=>document.querySelector(s);
const ingBody=$('#ingBody'), roundDp=$('#roundDp'), servingSize=$('#servingSize'), servingsPerPack=$('#servingsPerPack');
function r(v,dp){const n=Number(v); if(!isFinite(n)) return 0; const f=10**dp; return Math.round(n*f)/f;}
function kcal(p,c,f,sa=0){return (4*p)+(4*c)+(9*f)+(2.4*sa);}
function saltFromSodium_g(na_g){return na_g*2.5;}

/* ===== Table ops ===== */
function addRow(prefill){const tr=document.createElement('tr');
  tr.innerHTML=`<td><input class="ing-name" list="ing-list" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö" value="${prefill?.name||''}"></td>
    <td><select class="ing-method">${Object.keys(PRESETS).map(k=>`<option ${prefill?.method===k?'selected':''}>${k}</option>`).join('')}</select></td>
    <td><input class="ing-raw" type="number" step="0.1" placeholder="g" value="${prefill?.raw||''}"></td>
    <td><input class="ing-yield" type="number" step="0.01" placeholder="0.85" value="${prefill?.yld??1}"></td>
    <td><input class="ing-ret-p" type="number" step="0.01" placeholder="0.95" value="${prefill?.rp??1}"></td>
    <td><input class="ing-ret-f" type="number" step="0.01" placeholder="1.00" value="${prefill?.rf??1}"></td>
    <td><input class="ing-ret-c" type="number" step="0.01" placeholder="0.90" value="${prefill?.rc??1}"></td>
    <td><input class="ing-ret-fi" type="number" step="0.01" placeholder="0.90" value="${prefill?.rfi??1}"></td>
    <td><input class="ing-ret-na" type="number" step="0.01" placeholder="1.00" value="${prefill?.rna??1}"></td>
    <td><button class="btn danger btn-del">‡∏•‡∏ö</button></td>`;
  ingBody.appendChild(tr);
  tr.querySelector('.btn-del').addEventListener('click',()=>{tr.remove(); compute();});
  ['ing-name','ing-raw','ing-yield','ing-ret-p','ing-ret-f','ing-ret-c','ing-ret-fi','ing-ret-na'].forEach(cls=> tr.querySelector('.'+cls).addEventListener('input', compute));
  tr.querySelector('.ing-method').addEventListener('change',()=>{
    const p=PRESETS[tr.querySelector('.ing-method').value]; if(!p) return;
    tr.querySelector('.ing-yield').value=p.yld; tr.querySelector('.ing-ret-p').value=p.rp; tr.querySelector('.ing-ret-f').value=p.rf;
    tr.querySelector('.ing-ret-c').value=p.rc; tr.querySelector('.ing-ret-fi').value=p.rfi; tr.querySelector('.ing-ret-na').value=p.rna; compute();
  });
}
document.getElementById('btnAdd').addEventListener('click',()=>addRow());
document.getElementById('btnClear').addEventListener('click',()=>{ingBody.innerHTML=''; compute();});
document.getElementById('btnSample').addEventListener('click',()=>{
  ingBody.innerHTML=''; addRow({name:'‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢‡∏´‡∏∏‡∏á‡∏™‡∏∏‡∏Å',method:'‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏î‡∏¥‡∏ö',raw:300,yld:1,rp:1,rf:1,rc:1,rfi:1,rna:1});
  addRow({name:'‡∏≠‡∏Å‡πÑ‡∏Å‡πà‡∏î‡∏¥‡∏ö',method:'‡∏¢‡πà‡∏≤‡∏á/‡∏≠‡∏ö',raw:200,yld:0.8,rp:0.95,rf:1,rc:0.95,rfi:0.9,rna:1});
  addRow({name:'‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤',method:'‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏î‡∏¥‡∏ö',raw:15,yld:1,rp:1,rf:1,rc:1,rfi:1,rna:1});
  servingSize.value=150; servingsPerPack.value=4; roundDp.value=1; compute();
});
document.getElementById('searchIngredient').addEventListener('change',()=>{
  const v=document.getElementById('searchIngredient').value.trim(); if(!v) return;
  const hit=DB.find(d=>d.name===v); addRow({name:hit?hit.name:v,method:'‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏î‡∏¥‡∏ö',raw:100}); document.getElementById('searchIngredient').value=''; compute();
});
[roundDp,servingSize,servingsPerPack].forEach(el=>el.addEventListener('input', compute));

/* ===== Compute ===== */
function compute(){
  const dp=Number(roundDp.value||1);
  let totalProtein=0,totalFat=0,totalCarb=0,totalFiber=0,totalSodium_mg=0,totalCookedWeight=0;

  [...ingBody.querySelectorAll('tr')].forEach(tr=>{
    const name=tr.querySelector('.ing-name').value.trim();
    const raw=Number(tr.querySelector('.ing-raw').value||0);
    const yld=Number(tr.querySelector('.ing-yield').value||1);
    const rp=Number(tr.querySelector('.ing-ret-p').value||1);
    const rf=Number(tr.querySelector('.ing-ret-f').value||1);
    const rc=Number(tr.querySelector('.ing-ret-c').value||1);
    const rfi=Number(tr.querySelector('.ing-ret-fi').value||1);
    const rna=Number(tr.querySelector('.ing-ret-na').value||1);
    if(!raw||raw<=0) return;

    const base=DB.find(d=>d.name===name);
    const P100=base?.protein??0,F100=base?.fat??0,C100=base?.carbs??0,FI100=base?.fiber??0,NA100=base?.sodium_mg??0;

    const p=(P100/100)*raw, f=(F100/100)*raw, c=(C100/100)*raw, fi=(FI100/100)*raw, na_mg=(NA100/100)*raw;
    totalCookedWeight += raw*yld;
    totalProtein+=p*rp; totalFat+=f*rf; totalCarb+=c*rc; totalFiber+=fi*rfi; totalSodium_mg+=na_mg*rna;
  });

  const FW=totalCookedWeight; const SS=Number(servingSize.value)||0;
  const totalEnergy=kcal(totalProtein,totalCarb,totalFat);
  const totalSalt_g=saltFromSodium_g(totalSodium_mg/1000);

  const factor100=FW>0?100/FW:0;
  const p100=totalProtein*factor100, f100=totalFat*factor100, c100=totalCarb*factor100, fi100=totalFiber*factor100;
  const na100_mg=totalSodium_mg*factor100, salt100_g=totalSalt_g*factor100, kcal100=kcal(p100,c100,f100);

  const factorS=(SS>0&&FW>0)?SS/FW:0;
  const ps=totalProtein*factorS, fs=totalFat*factorS, cs=totalCarb*factorS, fis=totalFiber*factorS;
  const nas_mg=totalSodium_mg*factorS, salts_g=totalSalt_g*factorS, kcals=kcal(ps,cs,fs);

  document.getElementById('totalsGrid').innerHTML=[
    chip('‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°',r(totalEnergy,dp),'kcal'),
    chip('‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏£‡∏ß‡∏°',r(totalProtein,dp),'g'),
    chip('‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏£‡∏ß‡∏°',r(totalFat,dp),'g'),
    chip('‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏£‡∏ß‡∏°',r(totalCarb,dp),'g'),
    chip('‡πÉ‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏ß‡∏°',r(totalFiber,dp),'g'),
    chip('‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°‡∏£‡∏ß‡∏°',r(totalSodium_mg,dp),'mg'),
    chip('‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°',r(totalSalt_g,dp),'g'),
    chip('‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á',r(FW,dp),'g')
  ].join('');

  document.getElementById('convertGrid').innerHTML=[
    `<div class="chip"><strong>‡∏ï‡πà‡∏≠ 100 g</strong><span></span></div>`,
    chip('‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô',r(kcal100,dp),'kcal'),
    chip('‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô',r(p100,dp),'g'),
    chip('‡πÑ‡∏Ç‡∏°‡∏±‡∏ô',r(f100,dp),'g'),
    chip('‡∏Ñ‡∏≤‡∏£‡πå‡∏ö',r(c100,dp),'g'),
    chip('‡πÉ‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£',r(fi100,dp),'g'),
    chip('‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°',r(na100_mg,dp),'mg'),
    chip('‡πÄ‡∏Å‡∏•‡∏∑‡∏≠',r(salt100_g,dp),'g'),
    `<div class="chip"><strong>‡∏ï‡πà‡∏≠ serving (${r(SS,dp)} g)</strong><span></span></div>`,
    chip('‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô',r(kcals,dp),'kcal'),
    chip('‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô',r(ps,dp),'g'),
    chip('‡πÑ‡∏Ç‡∏°‡∏±‡∏ô',r(fs,dp),'g'),
    chip('‡∏Ñ‡∏≤‡∏£‡πå‡∏ö',r(cs,dp),'g'),
    chip('‡πÉ‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£',r(fis,dp),'g'),
    chip('‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°',r(nas_mg,dp),'mg'),
    chip('‡πÄ‡∏Å‡∏•‡∏∑‡∏≠',r(salts_g,dp),'g')
  ].join('');

  const ash=2; const moisture=100-(p100+f100+c100+fi100+ash);
  document.getElementById('massCheck').textContent=
    `‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô + ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô + ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö + ‡πÉ‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£ + ‡πÄ‡∏ñ‡πâ‡∏≤(${ash} g) + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô(‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì) = ${r(p100,1)} + ${r(f100,1)} + ${r(c100,1)} + ${r(fi100,1)} + ${ash} + ${r(moisture,1)} ‚âà ${r(p100+f100+c100+fi100+ash+moisture,1)} g`;
}
function chip(label,v,u){return `<div class="chip"><span>${label}</span><strong>${v} ${u}</strong></div>`;}

/* ===== Export ===== */
function toCSV(rows){return rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');}
function downloadCSV(name,csv){const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}
function exportXLSX(filename, sheets){const wb=XLSX.utils.book_new(); for(const {name,rows} of sheets){const ws=XLSX.utils.aoa_to_sheet(rows); XLSX.utils.book_append_sheet(wb,ws,name);} XLSX.writeFile(wb,filename);}
function rowsForResults(){
  compute();
  const t=document.querySelectorAll('#totalsGrid .chip strong'); const c=document.querySelectorAll('#convertGrid .chip strong'); const rows=[];
  rows.push(['meta','serving_size_g',document.getElementById('servingSize').value]);
  rows.push(['meta','servings_per_pack',document.getElementById('servingsPerPack').value]);
  ['kcal_total','protein_total_g','fat_total_g','carb_total_g','fiber_total_g','sodium_total_mg','salt_total_g','final_weight_g']
    .forEach((k,i)=>rows.push(['total',k,t[i]?.textContent||'']));
  ['kcal_100g','protein_100g_g','fat_100g_g','carb_100g_g','fiber_100g_g','sodium_100g_mg','salt_100g_g']
    .forEach((k,i)=>rows.push(['per100g',k,c[i+1]?.textContent||'']));
  ['kcal_per_serving','protein_per_serving_g','fat_per_serving_g','carb_per_serving_g','fiber_per_serving_g','sodium_per_serving_mg','salt_per_serving_g']
    .forEach((k,i)=>rows.push(['perserving',k,c[8+1+i]?.textContent||'']));
  return rows;
}
function rowsForIngredients(){
  const head=['name','method','raw_g','yield','ret_protein','ret_fat','ret_carb','ret_fiber','ret_sodium'];
  const rows=[head];
  [...document.querySelectorAll('#ingBody tr')].forEach(tr=>{
    rows.push([
      tr.querySelector('.ing-name').value, tr.querySelector('.ing-method').value, tr.querySelector('.ing-raw').value,
      tr.querySelector('.ing-yield').value, tr.querySelector('.ing-ret-p').value, tr.querySelector('.ing-ret-f').value,
      tr.querySelector('.ing-ret-c').value, tr.querySelector('.ing-ret-fi').value, tr.querySelector('.ing-ret-na').value
    ]);
  }); return rows;
}
document.getElementById('btnExportResults').addEventListener('click',()=>{downloadCSV('nutrition_results.csv',toCSV(rowsForResults())); showToast('Export CSV ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß'); confetti({particleCount:80,spread:70,origin:{y:.8}});});
document.getElementById('btnExportIngs').addEventListener('click',()=>{downloadCSV('ingredients_input.csv',toCSV(rowsForIngredients())); showToast('Export CSV ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß'); confetti({particleCount:80,spread:70,origin:{y:.8}});});
document.getElementById('btnExportResultsXLSX').addEventListener('click',()=>{exportXLSX('nutrition_results.xlsx',[{name:'results',rows:rowsForResults()}]); showToast('Export XLSX ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß'); confetti({particleCount:80,spread:70,origin:{y:.8}});});
document.getElementById('btnExportIngsXLSX').addEventListener('click',()=>{exportXLSX('nutrition_input.xlsx',[{name:'ingredients',rows:rowsForIngredients()}]); showToast('Export XLSX ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß'); confetti({particleCount:80,spread:70,origin:{y:.8}});});

/* ===== Startup ===== */
window.addEventListener('DOMContentLoaded',async()=>{
  const [l1,l2,l3]=LOGOS; safeSetLogo('logo1',l1); safeSetLogo('logo2',l2); safeSetLogo('logo3',l3);
  document.getElementById('creditTop').textContent=CREDIT_TEXT; document.getElementById('creditBottom').textContent=CREDIT_TEXT;
  await loadDB(); document.getElementById('ing-list').innerHTML=DB.map(d=>`<option value="${d.name}">`).join('');
  addRow(); compute(); attachRipple();
});
</script>
</body>
</html>
